---
import { ClientRouter } from 'astro:transitions'
import katexCSS from 'katex/dist/katex.min.css?url'
import { allLocales, base, defaultLocale, themeConfig } from '@/config'
import { ui } from '@/i18n/ui'
import { getPageInfo } from '@/utils/page'

interface Props {
  postTitle?: string
  postDescription?: string
  postSlug?: string
  postKeywords?: string
  postPublishedTime?: string
  postModifiedTime?: string
  postAuthor?: string
  postSection?: string
  postTags?: string[]
  postWords?: number
  tagName?: string
  categoryName?: string
}

// Props and Language
const {
  postTitle,
  postDescription,
  postSlug,
  postKeywords,
  postPublishedTime,
  postModifiedTime,
  postAuthor,
  postSection,
  postTags = [],
  postWords,
  tagName,
  categoryName,
} = Astro.props
const { currentLang } = getPageInfo(Astro.url.pathname)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}

// Site Configuration
const { title, subtitle, description, i18nTitle, author, keywords = '' } = themeConfig.site
const { mode: defaultMode, light: { background: lightMode }, dark: { background: darkMode } } = themeConfig.color
const { katex: katexEnabled, reduceMotion } = themeConfig.global
const {
  verification = {},
  twitterID = '',
  twitterCreator = '',
  googleAnalyticsID = '',
  umamiAnalyticsID = '',
  robots = 'index, follow',
  googlebot = 'index, follow',
  bingbot = 'index, follow',
} = themeConfig.seo ?? {}
const { google = '', bing = '', yandex = '', baidu = '' } = verification
const { customGoogleAnalyticsJS = '', customUmamiAnalyticsJS = '' } = themeConfig.preload ?? {}

// Site Metadata
const metaTheme = defaultMode === 'dark' ? darkMode : lightMode
const siteTitle = i18nTitle ? currentUI.title : title
const siteSubtitle = i18nTitle ? currentUI.subtitle : subtitle
const siteDescription = i18nTitle ? currentUI.description : description
const siteKeywords = i18nTitle ? currentUI.keywords || keywords : keywords

// Page Metadata
const pageTitle = postTitle ? `${postTitle} | ${siteTitle}` : `${siteTitle} - ${siteSubtitle}`
const pageDescription = postDescription || siteDescription
const pageKeywords = postKeywords || siteKeywords
const pageImage = postSlug
  ? new URL(`${base}/og/${postSlug}.png`, Astro.url.origin)
  : new URL(`${base}/og/index.png`, Astro.url.origin)
const pageUrl = Astro.url.href
const pageDomain = Astro.url.hostname
const pageLocale = currentLang === 'zh-tw' ? 'zh_TW' : currentLang.replace('-', '_')

// Schema Logic
const {
  isHome,
  isPost,
  isTag,
  isCategory,
  isSearch,
  isCopyright,
  isPostsListing,
} = getPageInfo(Astro.url.pathname)

const orgId = 'https://ultimatetech.org/#organization'
const webSiteId = 'https://ultimatetech.org/#website'
const authorId = 'https://me.hsinghhira.me/#person'

const schemaGraph: any[] = []

// 1. Organization (Always defined for consistency, though GEMINI.md says homepage, reference-ability is key)
const organizationSchema = {
  '@type': 'Organization',
  '@id': orgId,
  'name': 'Ultimate Tech',
  'url': 'https://ultimatetech.org/',
  'logo': {
    '@type': 'ImageObject',
    'url': new URL(`${base}/icons/logo.png`, Astro.url.origin).toString(),
    'width': 600,
    'height': 60,
  },
  'sameAs': [
    'https://x.com/HSinghHira',
    'https://github.com/UltimateTechbyHira/UltimateTech',
  ],
}

if (isHome) {
  schemaGraph.push(organizationSchema)
  schemaGraph.push({
    '@type': 'WebSite',
    '@id': webSiteId,
    'url': 'https://ultimatetech.org/',
    'name': 'Ultimate Tech',
    'description': siteDescription,
    'publisher': { '@id': orgId },
    'inLanguage': 'en',
    'potentialAction': {
      '@type': 'SearchAction',
      'target': 'https://ultimatetech.org/search/?q={search_term_string}',
      'query-input': 'required name=search_term_string',
    },
  })
}

if (isPostsListing) {
  schemaGraph.push({
    '@type': 'CollectionPage',
    '@id': 'https://ultimatetech.org/posts/#page',
    'url': 'https://ultimatetech.org/posts/',
    'name': 'Posts',
    'description': 'Browse all tech tutorials, how-to guides, and articles on Ultimate Tech.',
    'isPartOf': { '@id': webSiteId },
    'inLanguage': 'en',
  })
  schemaGraph.push({
    '@type': 'BreadcrumbList',
    'itemListElement': [
      { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': 'https://ultimatetech.org/' },
      { '@type': 'ListItem', 'position': 2, 'name': 'Posts', 'item': 'https://ultimatetech.org/posts/' },
    ],
  })
}

if (isPost) {
  schemaGraph.push({
    '@type': 'TechArticle',
    '@id': `${pageUrl}#article`,
    'mainEntityOfPage': { '@type': 'WebPage', '@id': pageUrl },
    'headline': postTitle,
    'description': pageDescription,
    'image': pageImage.toString(),
    'datePublished': postPublishedTime,
    'dateModified': postModifiedTime || postPublishedTime,
    'author': {
      '@type': 'Person',
      '@id': authorId,
      'name': 'Harman Singh Hira',
      'url': 'https://me.hsinghhira.me/',
    },
    'publisher': { '@id': orgId },
    'keywords': pageKeywords ? pageKeywords.split(',').map(k => k.trim()) : [],
    'wordCount': postWords,
    'inLanguage': 'en',
    'isPartOf': { '@id': webSiteId },
  })
  schemaGraph.push({
    '@type': 'BreadcrumbList',
    'itemListElement': [
      { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': 'https://ultimatetech.org/' },
      { '@type': 'ListItem', 'position': 2, 'name': 'Posts', 'item': 'https://ultimatetech.org/posts/' },
      { '@type': 'ListItem', 'position': 3, 'name': postTitle, 'item': pageUrl },
    ],
  })
}

if (isCategory && categoryName) {
  schemaGraph.push({
    '@type': 'CollectionPage',
    '@id': `https://ultimatetech.org/categories/${categoryName}/#page`,
    'url': `https://ultimatetech.org/categories/${categoryName}/`,
    'name': categoryName,
    'description': `Browse all Ultimate Tech articles in the ${categoryName} category.`,
    'isPartOf': { '@id': webSiteId },
    'inLanguage': 'en',
  })
  schemaGraph.push({
    '@type': 'BreadcrumbList',
    'itemListElement': [
      { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': 'https://ultimatetech.org/' },
      { '@type': 'ListItem', 'position': 2, 'name': 'Categories', 'item': 'https://ultimatetech.org/categories/' },
      { '@type': 'ListItem', 'position': 3, 'name': categoryName, 'item': `https://ultimatetech.org/categories/${categoryName}/` },
    ],
  })
}

if (isTag && tagName) {
  schemaGraph.push({
    '@type': 'CollectionPage',
    '@id': `https://ultimatetech.org/tags/${tagName}/#page`,
    'url': `https://ultimatetech.org/tags/${tagName}/`,
    'name': tagName,
    'description': `Browse all Ultimate Tech articles tagged with ${tagName}.`,
    'isPartOf': { '@id': webSiteId },
    'inLanguage': 'en',
  })
  schemaGraph.push({
    '@type': 'BreadcrumbList',
    'itemListElement': [
      { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': 'https://ultimatetech.org/' },
      { '@type': 'ListItem', 'position': 2, 'name': 'Tags', 'item': 'https://ultimatetech.org/tags/' },
      { '@type': 'ListItem', 'position': 3, 'name': tagName, 'item': `https://ultimatetech.org/tags/${tagName}/` },
    ],
  })
}

if (isSearch) {
  schemaGraph.push({
    '@type': 'SearchResultsPage',
    '@id': 'https://ultimatetech.org/search/#page',
    'url': 'https://ultimatetech.org/search/',
    'name': 'Search',
    'description': 'Search articles, tutorials, and guides on Ultimate Tech.',
    'isPartOf': { '@id': webSiteId },
    'inLanguage': 'en',
  })
  schemaGraph.push({
    '@type': 'BreadcrumbList',
    'itemListElement': [
      { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': 'https://ultimatetech.org/' },
      { '@type': 'ListItem', 'position': 2, 'name': 'Search', 'item': 'https://ultimatetech.org/search/' },
    ],
  })
}

if (isCopyright) {
  schemaGraph.push({
    '@type': 'WebPage',
    '@id': 'https://ultimatetech.org/copyright/#page',
    'url': 'https://ultimatetech.org/copyright/',
    'name': 'Copyright',
    'description': 'Copyright policy and terms for Ultimate Tech.',
    'isPartOf': { '@id': webSiteId },
    'inLanguage': 'en',
  })
  schemaGraph.push({
    '@type': 'BreadcrumbList',
    'itemListElement': [
      { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': 'https://ultimatetech.org/' },
      { '@type': 'ListItem', 'position': 2, 'name': 'Copyright', 'item': 'https://ultimatetech.org/copyright/' },
    ],
  })
}
---

<head>
<!-- Preconnect -->
<link rel="preconnect" href="https://www.googletagmanager.com" />
<link rel="preconnect" href="https://cloud.umami.is" />
<!-- Basic Info -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<link rel="apple-touch-icon" sizes="180x180" href={`${base}/icons/apple-touch-icon.png`} />
<link rel="icon" type="image/png" sizes="32x32" href={`${base}/icons/favicon-32x32.png`} />
<link rel="icon" type="image/png" sizes="16x16" href={`${base}/icons/favicon-16x16.png`} />
<link rel="manifest" href={`${base}/icons/site.webmanifest`} />
<title>{pageTitle}</title>
<meta name="description" content={pageDescription} />
<meta name="author" content={postAuthor || author} />
<meta name="generator" content={Astro.generator} />
<meta name="theme-color" content={metaTheme} />
{pageKeywords && <meta name="keywords" content={pageKeywords} />}
<meta name="language" content={currentLang} />

<!-- Robots Meta Tags -->
<meta name="robots" content={robots} />
<meta name="googlebot" content={googlebot} />
<meta name="bingbot" content={bingbot} />

<!-- Mobile & App Meta Tags -->
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content={siteTitle} />

<!-- Preload -->
<link rel="preload" href={`${base}/fonts/EarlySummer-VF-Split/EarlySummer-VF-Subset.woff2`} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={`${base}/fonts/Snell-Black-SF.woff2`} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={`${base}/fonts/Snell-Bold-SF.woff2`} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={`${base}/fonts/STIX-VF.woff2`} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={`${base}/fonts/STIX-Italic-VF.woff2`} as="font" type="font/woff2" crossorigin />
{katexEnabled && <link rel="stylesheet" href={katexCSS} media="print" onload={`this.media='all'`} />}

<!-- Site Links -->
<link rel="canonical" href={Astro.url} />
<link rel="sitemap" href={`${base}/sitemap-index.xml`} />
<link rel="alternate" href={`${base}/rss.xml`} type="application/rss+xml" title="RSS Feed" />
<link rel="alternate" href={`${base}/atom.xml`} type="application/atom+xml" title="Atom Feed" />
<link rel="alternate" href={`${Astro.url.origin}${base}/`} hreflang="x-default" />
{allLocales.map(lang => (
  <link
    rel="alternate"
    href={`${Astro.url.origin}${base}${lang === defaultLocale ? '' : `/${lang}/`}`}
    hreflang={lang === 'zh-tw' ? 'zh-TW' : lang}
  />
))}

<!-- Open Graph Meta Tags -->
<meta property="og:type" content={postTitle ? 'article' : 'website'} />
<meta property="og:site_name" content={siteTitle} />
<meta property="og:url" content={pageUrl} />
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={pageDescription} />
<meta property="og:image" content={pageImage} />
<meta property="og:locale" content={pageLocale} />
{allLocales
  .filter(lang => lang !== currentLang)
  .map(lang => (
    <meta
      property="og:locale:alternate"
      content={lang === 'zh-tw' ? 'zh_TW' : lang.replace('-', '_')}
    />
  ))}

<!-- Article Meta Tags (for blog posts) -->
{postTitle && (
  <>
    {postPublishedTime && <meta property="article:published_time" content={postPublishedTime} />}
    {postModifiedTime && <meta property="article:modified_time" content={postModifiedTime} />}
    {postAuthor && <meta property="article:author" content={postAuthor} />}
    {postSection && <meta property="article:section" content={postSection} />}
    {postTags.map(tag => (
      <meta property="article:tag" content={tag} />
    ))}
  </>
)}

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
{twitterID && <meta name="twitter:site" content={twitterID} />}
{twitterCreator && <meta name="twitter:creator" content={twitterCreator} />}
<meta name="twitter:url" content={pageUrl} />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={pageDescription} />
<meta name="twitter:image" content={pageImage} />
<meta name="twitter:domain" content={pageDomain} />

<!-- Site Verification -->
{google && <meta name="google-site-verification" content={google} />}
{bing && <meta name="msvalidate.01" content={bing} />}
{yandex && <meta name="yandex-verification" content={yandex} />}
{baidu && <meta name="baidu-site-verification" content={baidu} />}

<!-- JSON-LD Structured Data -->
{schemaGraph.length > 0 && (
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@graph': schemaGraph,
    })}
  />
)}

<!-- Analytics Initialization -->
<script>
  import { trackCodeCopy, trackEngagementTime, trackOutboundClicks, trackScrollDepth } from '@/utils/analytics'

  function initAnalytics() {
    const postSlug = document.body.getAttribute('data-post-slug')
    if (postSlug) {
      trackScrollDepth(postSlug)
      trackEngagementTime(postSlug)
      trackOutboundClicks(postSlug)
      trackCodeCopy(postSlug)
    }
  }

  // Initialize on first load
  initAnalytics()

  // Re-initialize after view transitions
  document.addEventListener('astro:after-swap', initAnalytics)
</script>

<!-- Global View Transition -->
<ClientRouter fallback="none" />

<!-- Theme Toggle -->
<script
  is:inline
  define:vars={{
    defaultMode,
    lightMode,
    darkMode,
    reduceMotion,
 }}
>
(function () {
  // Check if current theme is dark
  // Priority: localStorage theme > default theme > system preference
  function isCurrentDark() {
    const currentTheme = localStorage.getItem('theme')
    if (currentTheme) {
      return currentTheme === 'dark'
    }

    if (defaultMode !== 'auto') {
      return defaultMode === 'dark'
    }

    // If defaultMode is auto, follow system preference
    return window.matchMedia('(prefers-color-scheme: dark)').matches
  }

  // Initialize theme
  function initTheme(doc = document) {
    const isDark = isCurrentDark()
    doc.documentElement.classList.toggle('dark', isDark)

    // Update meta theme-color tag
    const metaThemeColor = doc.head.querySelector('meta[name="theme-color"]')
    if (metaThemeColor) {
      metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
    }
  }

  // Check and init motion preference
  // Condition: theme config || system preference || browser capability
  function initMotionPref(doc = document) {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    const supportsViewTransitions = 'startViewTransition' in doc
    const shouldReduceMotion = reduceMotion || prefersReducedMotion || !supportsViewTransitions

    doc.documentElement.classList.toggle('reduce-motion', shouldReduceMotion)
  }

  // Update theme before page transition to prevent flashing
  document.addEventListener('astro:before-swap', ({ newDocument }) => {
    initTheme(newDocument)
    initMotionPref(newDocument)
  })

  // Initialize theme on first load
  initTheme()
  initMotionPref()
})()
</script>

<!-- Google Analytics -->
<!-- Define gtag on window object for proper Partytown forwarding -->
<!-- See https://github.com/QwikDev/partytown/issues/382 -->
{googleAnalyticsID && (
  <>
    <script
      is:inline
      type="text/partytown"
      src={customGoogleAnalyticsJS || `https://www.googletagmanager.com/gtag/js?id=${googleAnalyticsID}`}
    />
    <script
      is:inline
      type="text/partytown"
      define:vars={{
        googleAnalyticsID,
        customGoogleAnalyticsJS,
      }}
    >
      window.dataLayer = window.dataLayer || []
      window.gtag = function () {
        // eslint-disable-next-line prefer-rest-params
        dataLayer.push(arguments)
      }
      window.gtag('js', new Date())

      if (customGoogleAnalyticsJS) {
        window.gtag('config', googleAnalyticsID, {
          transport_url: new URL(customGoogleAnalyticsJS).origin,
        })
      }
      else {
        window.gtag('config', googleAnalyticsID)
      }
    </script>
  </>
)}

<!-- Umami Analytics -->
{umamiAnalyticsID && (
  <script
    is:inline
    type="text/partytown"
    src={customUmamiAnalyticsJS || 'https://cloud.umami.is/script.js'}
    data-website-id={umamiAnalyticsID}
  />
)}
</head>
