---
import { ClientRouter } from 'astro:transitions'
import katexCSS from 'katex/dist/katex.min.css?url'
import { allLocales, base, defaultLocale, themeConfig } from '@/config'
import { ui } from '@/i18n/ui'
import { getPageInfo } from '@/utils/page'

interface Props {
  postTitle?: string
  postDescription?: string
  postSlug?: string
  postKeywords?: string
  postPublishedTime?: string
  postModifiedTime?: string
  postAuthor?: string
  postSection?: string
  postTags?: string[]
}

// Props and Language
const {
  postTitle,
  postDescription,
  postSlug,
  postKeywords,
  postPublishedTime,
  postModifiedTime,
  postAuthor,
  postSection,
  postTags = [],
} = Astro.props
const { currentLang } = getPageInfo(Astro.url.pathname)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}

// Site Configuration
const { title, subtitle, description, i18nTitle, author, keywords = '' } = themeConfig.site
const { mode: defaultMode, light: { background: lightMode }, dark: { background: darkMode } } = themeConfig.color
const { katex: katexEnabled, reduceMotion } = themeConfig.global
const {
  verification = {},
  twitterID = '',
  twitterCreator = '',
  googleAnalyticsID = '',
  umamiAnalyticsID = '',
  robots = 'index, follow',
  googlebot = 'index, follow',
  bingbot = 'index, follow',
} = themeConfig.seo ?? {}
const { google = '', bing = '', yandex = '', baidu = '' } = verification
const { customGoogleAnalyticsJS = '', customUmamiAnalyticsJS = '' } = themeConfig.preload ?? {}

// Site Metadata
const metaTheme = defaultMode === 'dark' ? darkMode : lightMode
const siteTitle = i18nTitle ? currentUI.title : title
const siteSubtitle = i18nTitle ? currentUI.subtitle : subtitle
const siteDescription = i18nTitle ? currentUI.description : description
const siteKeywords = i18nTitle ? currentUI.keywords || keywords : keywords

// Page Metadata
const pageTitle = postTitle ? `${postTitle} | ${siteTitle}` : `${siteTitle} - ${siteSubtitle}`
const pageDescription = postDescription || siteDescription
const pageKeywords = postKeywords || siteKeywords
const pageImage = postSlug
  ? new URL(`${base}/og/${postSlug}.png`, Astro.url.origin)
  : new URL(`${base}/og/index.png`, Astro.url.origin)
const pageUrl = Astro.url.href
const pageDomain = Astro.url.hostname
const pageLocale = currentLang === 'zh-tw' ? 'zh_TW' : currentLang.replace('-', '_')
---

<head>
<!-- Preconnect -->
{googleAnalyticsID && <link rel="preconnect" href="https://www.googletagmanager.com" />}
{umamiAnalyticsID && (
  <>
    <link rel="preconnect" href="https://cloud.umami.is" />
    <link rel="preconnect" href="https://api-gateway.umami.dev" />
  </>
)}
<!-- Basic Info -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<link rel="apple-touch-icon" sizes="180x180" href={`${base}/icons/apple-touch-icon.png`} />
<link rel="icon" type="image/png" sizes="32x32" href={`${base}/icons/favicon-32x32.png`} />
<link rel="icon" type="image/png" sizes="16x16" href={`${base}/icons/favicon-16x16.png`} />
<link rel="manifest" href={`${base}/icons/site.webmanifest`} />
<title>{pageTitle}</title>
<meta name="description" content={pageDescription} />
<meta name="author" content={postAuthor || author} />
<meta name="generator" content={Astro.generator} />
<meta name="theme-color" content={metaTheme} />
{pageKeywords && <meta name="keywords" content={pageKeywords} />}
<meta name="language" content={currentLang} />

<!-- Robots Meta Tags -->
<meta name="robots" content={robots} />
<meta name="googlebot" content={googlebot} />
<meta name="bingbot" content={bingbot} />

<!-- Mobile & App Meta Tags -->
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content={siteTitle} />

<!-- Preload -->
<link rel="preload" href={`${base}/fonts/EarlySummer-VF-Split/EarlySummer-VF-Subset.woff2`} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={`${base}/fonts/Snell-Black-SF.woff2`} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={`${base}/fonts/Snell-Bold-SF.woff2`} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={`${base}/fonts/STIX-VF.woff2`} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={`${base}/fonts/STIX-Italic-VF.woff2`} as="font" type="font/woff2" crossorigin />
{katexEnabled && <link rel="stylesheet" href={katexCSS} media="print" onload={`this.media='all'`} />}

<!-- Site Links -->
<link rel="canonical" href={Astro.url} />
<link rel="sitemap" href={`${base}/sitemap-index.xml`} />
<link rel="alternate" href={`${base}/rss.xml`} type="application/rss+xml" title="RSS Feed" />
<link rel="alternate" href={`${base}/atom.xml`} type="application/atom+xml" title="Atom Feed" />
<link rel="alternate" href={`${Astro.url.origin}${base}/`} hreflang="x-default" />
{allLocales.map(lang => (
  <link
    rel="alternate"
    href={`${Astro.url.origin}${base}${lang === defaultLocale ? '' : `/${lang}/`}`}
    hreflang={lang === 'zh-tw' ? 'zh-TW' : lang}
  />
))}

<!-- Open Graph Meta Tags -->
<meta property="og:type" content={postTitle ? 'article' : 'website'} />
<meta property="og:site_name" content={siteTitle} />
<meta property="og:url" content={pageUrl} />
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={pageDescription} />
<meta property="og:image" content={pageImage} />
<meta property="og:locale" content={pageLocale} />
{allLocales
  .filter(lang => lang !== currentLang)
  .map(lang => (
    <meta
      property="og:locale:alternate"
      content={lang === 'zh-tw' ? 'zh_TW' : lang.replace('-', '_')}
    />
  ))}

<!-- Article Meta Tags (for blog posts) -->
{postTitle && (
  <>
    {postPublishedTime && <meta property="article:published_time" content={postPublishedTime} />}
    {postModifiedTime && <meta property="article:modified_time" content={postModifiedTime} />}
    {postAuthor && <meta property="article:author" content={postAuthor} />}
    {postSection && <meta property="article:section" content={postSection} />}
    {postTags.map(tag => (
      <meta property="article:tag" content={tag} />
    ))}
  </>
)}

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
{twitterID && <meta name="twitter:site" content={twitterID} />}
{twitterCreator && <meta name="twitter:creator" content={twitterCreator} />}
<meta name="twitter:url" content={pageUrl} />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={pageDescription} />
<meta name="twitter:image" content={pageImage} />
<meta name="twitter:domain" content={pageDomain} />

<!-- Site Verification -->
{google && <meta name="google-site-verification" content={google} />}
{bing && <meta name="msvalidate.01" content={bing} />}
{yandex && <meta name="yandex-verification" content={yandex} />}
{baidu && <meta name="baidu-site-verification" content={baidu} />}

<!-- JSON-LD Structured Data -->
<script
  is:inline
  type="application/ld+json"
  set:html={JSON.stringify({
  '@context': 'https://schema.org',
  '@type': postTitle ? 'Article' : 'WebSite',
  ...(postTitle
? {
    headline: postTitle,
    description: pageDescription,
    image: pageImage.toString(),
    datePublished: postPublishedTime,
    dateModified: postModifiedTime || postPublishedTime,
    author: {
      '@type': 'Person',
      'name': 'Harman Singh Hira',
    },
    publisher: {
      '@type': 'Organization',
      'name': 'Ultimate Tech',
      'logo': {
        '@type': 'ImageObject',
        'url': new URL(`${base}/icons/apple-touch-icon.png`, Astro.url.origin).toString(),
      },
    },
  }
: {
    name: siteTitle,
    description: siteDescription,
    url: pageUrl,
  }),
})}
/>

<!-- Global View Transition -->
<ClientRouter fallback="none" />

<!-- Theme Toggle -->
<script
  is:inline
  define:vars={{
    defaultMode,
    lightMode,
    darkMode,
    reduceMotion,
 }}
>
(function () {
  // Check if current theme is dark
  // Priority: localStorage theme > default theme > system preference
  function isCurrentDark() {
    const currentTheme = localStorage.getItem('theme')
    if (currentTheme) {
      return currentTheme === 'dark'
    }

    if (defaultMode !== 'auto') {
      return defaultMode === 'dark'
    }

    // If defaultMode is auto, follow system preference
    return window.matchMedia('(prefers-color-scheme: dark)').matches
  }

  // Initialize theme
  function initTheme(doc = document) {
    const isDark = isCurrentDark()
    doc.documentElement.classList.toggle('dark', isDark)

    // Update meta theme-color tag
    const metaThemeColor = doc.head.querySelector('meta[name="theme-color"]')
    if (metaThemeColor) {
      metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
    }
  }

  // Check and init motion preference
  // Condition: theme config || system preference || browser capability
  function initMotionPref(doc = document) {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    const supportsViewTransitions = 'startViewTransition' in doc
    const shouldReduceMotion = reduceMotion || prefersReducedMotion || !supportsViewTransitions

    doc.documentElement.classList.toggle('reduce-motion', shouldReduceMotion)
  }

  // Update theme before page transition to prevent flashing
  document.addEventListener('astro:before-swap', ({ newDocument }) => {
    initTheme(newDocument)
    initMotionPref(newDocument)
  })

  // Initialize theme on first load
  initTheme()
  initMotionPref()
})()
</script>

<!-- Google Analytics -->
<!-- Using defer (not async) so the inline config script below always runs first.
     allow_google_signals/allow_ad_personalization_signals are disabled â€” these
     are what cause the SharedStorage/AttributionReporting deprecation warnings. -->
{googleAnalyticsID && (
  <>
    <script
      is:inline
      define:vars={{ googleAnalyticsID, customGoogleAnalyticsJS }}
    >
      window.dataLayer = window.dataLayer || []
      window.gtag = function () {
        // eslint-disable-next-line prefer-rest-params
        dataLayer.push(arguments)
      }
      window.gtag('js', new Date())
      window.gtag('config', googleAnalyticsID, {
        allow_google_signals: false,
        allow_ad_personalization_signals: false,
        ...(customGoogleAnalyticsJS && {
          transport_url: new URL(customGoogleAnalyticsJS).origin,
        }),
      })
    </script>
    <script
      is:inline
      defer
      src={customGoogleAnalyticsJS || `https://www.googletagmanager.com/gtag/js?id=${googleAnalyticsID}`}
    />
  </>
)}

<!-- Umami Analytics -->
{umamiAnalyticsID && (
  <script
    is:inline
    defer
    src={customUmamiAnalyticsJS || 'https://cloud.umami.is/script.js'}
    data-website-id={umamiAnalyticsID}
  />
)}
</head>
