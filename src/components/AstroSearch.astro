---
import '@/styles/AstroSearch.css'

export interface Props {
  readonly id?: string
  readonly className?: string
  readonly query?: string
  readonly uiOptions?: Record<string, any>
}

const { id, className, query, uiOptions = {} } = Astro.props
const bundlePath = `/pagefind/`;
---

<div
  id={id}
  class:list={[className, 'pagefind-init']}
  data-pagefind-ui
  data-bundle-path={bundlePath}
  data-query={query}
  data-ui-options={JSON.stringify(uiOptions)}
>
</div>

<!-- Load Pagefind UI Script -->
<script is:inline define:vars={{ bundlePath }}>
// Create script tag to load pagefind-ui.js
const script = document.createElement('script')
script.src = `${bundlePath}pagefind-ui.js`
script.type = 'text/partytown'
document.head.appendChild(script)
</script>

<script>
// Declare PagefindUI on window to satisfy TypeScript
declare global {
  interface Window {
    PagefindUI: any
  }
}

function initPageFind() {
  // Wait for PagefindUI to be available
  if (typeof window.PagefindUI === 'undefined') {
    setTimeout(initPageFind, 100)
    return
  }

  const allSelector = '[data-pagefind-ui]'
  const elements = Array.from(document.querySelectorAll(
    `${allSelector}.pagefind-init`,
  ))

  for (const el of elements) {
    const elSelector = [
      ...(el.id ? [`#${el.id}`] : []),
      ...Array.from(el.classList).map(c => `.${c}`),
      allSelector,
    ].join('')
    const bundlePath = el.getAttribute('data-bundle-path')
    const opts = JSON.parse(el.getAttribute('data-ui-options') ?? '{}')
    // eslint-disable-next-line no-new
    new window.PagefindUI({
      ...opts,
      element: elSelector,
      bundlePath,
    })
    el.classList.remove('pagefind-init')
    let query = el.getAttribute('data-query')

    // Check if the current URL has any query params
    const url = new URL(window.location.href)
    const params = new URLSearchParams(url.search)
    if (params.has('q')) {
      query = params.get('q')
    }

    const input = el.querySelector(`input[type="text"]`) as HTMLInputElement | null

    if (input) {
      input.focus()
    }

    if (input) {
      input.value = query ?? ''
      input.dispatchEvent(new Event('input', { bubbles: true }))

      // Add Listener to update the URL when the input changes
      input.addEventListener('input', (e) => {
        const input = e.target as HTMLInputElement
        const url = new URL(window.location.href)
        const params = new URLSearchParams(url.search)
        params.set('q', input.value)
        window.history.replaceState({}, '', `${url.pathname}?${params}`)
      })
    }
  }
}

document.addEventListener('astro:page-load', initPageFind)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initPageFind)
}
else {
  initPageFind()
}
</script>
