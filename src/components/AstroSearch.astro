---
import PostList from '@/components/PostList.astro'
import { getLangFromLocale } from '@/i18n/lang'
import { getRegularPosts } from '@/utils/content'
import '@/styles/AstroSearch.css'

export interface Props {
  readonly id?: string
  readonly className?: string
  readonly query?: string
  readonly uiOptions?: Record<string, any>
}

const { id, className, query, uiOptions = {} } = Astro.props
const bundlePath = `/pagefind/`
const currentLang = getLangFromLocale(Astro.currentLocale)
const posts = await getRegularPosts(currentLang)
---

<div id="pagefind-post-templates" style="display: none;">
  <PostList posts={posts} lang={currentLang} showDescription={true} />
</div>

<div
  id={id}
  class:list={[className, 'pagefind-init']}
  data-pagefind-ui
  data-bundle-path={bundlePath}
  data-query={query}
  data-ui-options={JSON.stringify(uiOptions)}
>
</div>

<!-- Load Pagefind UI Script -->
<script is:inline define:vars={{ bundlePath }}>
// Create script tag to load pagefind-ui.js
const script = document.createElement('script')
script.src = `${bundlePath}pagefind-ui.js`
document.head.appendChild(script)
</script>

<script>
// Declare PagefindUI on window to satisfy TypeScript
declare global {
  interface Window {
    PagefindUI: any
  }
}

function initPageFind() {
  // Wait for PagefindUI to be available
  if (typeof window.PagefindUI === 'undefined') {
    setTimeout(initPageFind, 100)
    return
  }

  const allSelector = '[data-pagefind-ui]'
  const elements = Array.from(document.querySelectorAll(
    `${allSelector}.pagefind-init`,
  ))

  for (const el of elements) {
    const elSelector = [
      ...(el.id ? [`#${el.id}`] : []),
      ...Array.from(el.classList).map(c => `.${c}`),
      allSelector,
    ].join('')
    const bundlePath = el.getAttribute('data-bundle-path')
    const opts = JSON.parse(el.getAttribute('data-ui-options') ?? '{}')
    // eslint-disable-next-line no-new
    new window.PagefindUI({
      ...opts,
      element: elSelector,
      bundlePath,
      processResult(result: any) {
        const templates = document.getElementById('pagefind-post-templates')
        if (templates) {
          // Normalize the URL
          let resultUrl = result.url.replace(window.location.origin, '')
          if (resultUrl && !resultUrl.endsWith('/'))
            resultUrl += '/'

          const links = Array.from(templates.querySelectorAll('a'))
          const link = links.find((a) => {
            const href = a.getAttribute('href')
            return href === resultUrl || href === resultUrl.replace(/\/$/, '') || `${href}/` === resultUrl
          })

          if (link) {
            const li = link.closest('li')
            if (li) {
              // Create an identical layout but wrapped in layout CSS overrides
              const html = `<div class="${li.className}">${li.innerHTML}</div>`
              result.excerpt = html
              result.meta.title = '' // Hide default title
              return result
            }
          }
        }

        return result
      },
    })
    el.classList.remove('pagefind-init')
    let query = el.getAttribute('data-query')

    // Check if the current URL has any query params
    const url = new URL(window.location.href)
    const params = new URLSearchParams(url.search)
    if (params.has('q')) {
      query = params.get('q')
    }

    const input = el.querySelector(`input[type="text"]`) as HTMLInputElement | null

    if (input) {
      input.focus()
    }

    if (input) {
      input.value = query ?? ''
      input.dispatchEvent(new Event('input', { bubbles: true }))

      // Add Listener to update the URL when the input changes
      input.addEventListener('input', (e) => {
        const input = e.target as HTMLInputElement
        const url = new URL(window.location.href)
        const params = new URLSearchParams(url.search)
        params.set('q', input.value)
        window.history.replaceState({}, '', `${url.pathname}?${params}`)
      })
    }
  }
}

document.addEventListener('astro:page-load', initPageFind)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initPageFind)
}
else {
  initPageFind()
}
</script>
