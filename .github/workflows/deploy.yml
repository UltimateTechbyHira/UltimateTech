name: Deploy to Cloudflare Pages

on:
  # Trigger on push to main branch
  push:
    branches:
      - main

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

permissions:
  contents: write
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    name: Build and Deploy to Cloudflare Pages

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for Git dates

      # Setup Node.js (Astro requires Node.js)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # Install dependencies
      - name: Install dependencies
        run: npm install

      # Fix publish dates in blog posts
      - name: Add missing dates to markdown files
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');

          function processMarkdownFiles(dir) {
            if (!fs.existsSync(dir)) {
              console.log(`Directory does not exist: ${dir}`);
              return;
            }

            const files = fs.readdirSync(dir, { withFileTypes: true });

            for (const file of files) {
              const fullPath = path.join(dir, file.name);

              if (file.isDirectory()) {
                processMarkdownFiles(fullPath);
              } else if (file.name.endsWith('.md')) {
                processFile(fullPath);
              }
            }
          }

          function processFile(filePath) {
            console.log(`\nProcessing: ${filePath}`);
            let content = fs.readFileSync(filePath, 'utf8');

            // Check if file has frontmatter
            if (!content.startsWith('---')) {
              console.log(`  ‚è≠Ô∏è  No frontmatter found, skipping`);
              return;
            }

            const frontmatterEnd = content.indexOf('---', 3);
            if (frontmatterEnd === -1) {
              console.log(`  ‚è≠Ô∏è  Malformed frontmatter, skipping`);
              return;
            }

            const frontmatter = content.substring(3, frontmatterEnd);
            const body = content.substring(frontmatterEnd + 3);

            // Get Git creation date (first commit) in ISO 8601 format
            let creationDate;
            try {
              const gitDate = execSync(
                `git log --follow --format=%aI --reverse "${filePath}" | head -1`,
                { encoding: 'utf8' }
              ).trim();
              creationDate = gitDate || new Date().toISOString();
            } catch (e) {
              creationDate = new Date().toISOString();
            }

            console.log(`  üìÖ Git creation date: ${creationDate}`);

            // Parse frontmatter into lines and build a clean version
            const lines = frontmatter.split('\n');
            const cleanedLines = [];
            let hasPublished = false;
            let needsFix = false;
            let publishedCount = 0;

            for (const line of lines) {
              const trimmedLine = line.trim();

              // Skip empty lines at the start
              if (!trimmedLine && cleanedLines.length === 0) {
                continue;
              }

              // Check if this is a 'published' field
              const pubMatch = trimmedLine.match(/^published:\s*(.+)$/);

              if (pubMatch) {
                publishedCount++;
                console.log(`  üîç Found 'published' field #${publishedCount}: ${trimmedLine}`);

                if (hasPublished) {
                  // Skip duplicate published field
                  console.log(`  ‚ùå Removing duplicate 'published' field`);
                  needsFix = true;
                  continue;
                }

                const rawValue = pubMatch[1].trim();
                const existingDate = rawValue.replace(/^['"]|['"]$/g, '');

                // Check if date format is correct
                if (!existingDate.includes('T') || rawValue.startsWith("'") || rawValue.startsWith('"')) {
                  console.log(`  üîß Fixing published date format: ${rawValue} -> ${creationDate}`);
                  cleanedLines.push(`published: ${creationDate}`);
                  needsFix = true;
                } else {
                  console.log(`  ‚úÖ Date format is correct`);
                  cleanedLines.push(line);
                }

                hasPublished = true;
              } else {
                // Keep other fields as-is
                cleanedLines.push(line);
              }
            }

            // Add 'published' if it doesn't exist
            if (!hasPublished) {
              console.log(`  ‚ûï Adding missing 'published' field`);
              cleanedLines.push(`published: ${creationDate}`);
              needsFix = true;
            }

            if (needsFix) {
              console.log(`  üíæ Writing fixes to file...`);
              // Rebuild frontmatter ensuring no extra blank lines at start
              let newFrontmatter = cleanedLines.join('\n').trim();
              const newContent = `---\n${newFrontmatter}\n---${body}`;
              fs.writeFileSync(filePath, newContent, 'utf8');
              console.log(`  ‚úÖ File updated successfully`);
            } else {
              console.log(`  ‚úÖ No changes needed`);
            }
          }

          // Process content directory (adjust path to match your structure)
          const contentDirs = ['src/content/posts', 'src/content/blog'];
          console.log('üîç Starting to scan for markdown files...\n');
          for (const dir of contentDirs) {
            console.log(`\nüìÅ Checking directory: ${dir}`);
            if (fs.existsSync(dir)) {
              processMarkdownFiles(dir);
            }
          }

          console.log('\n‚ú® Date fixing process complete!');
          EOF

      # Commit and push fixes if any were made
      - name: Commit date fixes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          echo "üìã Checking for changes..."
          git status
          git add -A
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to commit"
          else
            echo "üíæ Committing changes..."
            git commit -m "ü§ñ Auto-fix: Update publish dates in blog posts" --no-verify
            echo "üöÄ Pushing changes..."
            git push
            echo "‚úÖ Changes pushed successfully"
          fi

      # Format posts
      - name: Format posts
        run: npm run format-posts

      # Build the Astro site
      - name: Build Astro site
        run: npm run build

      # Deploy to Cloudflare Pages using Wrangler
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=ultimatetech --commit-dirty
