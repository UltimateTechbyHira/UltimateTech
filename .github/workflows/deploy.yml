name: Deploy to Cloudflare Pages

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

permissions:
  contents: write
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    name: Build and Deploy to Cloudflare Pages
    
    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for Git dates
      
      # Setup Node.js (Astro requires Node.js)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Install dependencies
      - name: Install dependencies
        run: npm install
      
      # Fix publish dates in blog posts
      - name: Add missing dates to markdown files
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');

          function processMarkdownFiles(dir) {
            if (!fs.existsSync(dir)) return;
            
            const files = fs.readdirSync(dir, { withFileTypes: true });
            
            for (const file of files) {
              const fullPath = path.join(dir, file.name);
              
              if (file.isDirectory()) {
                processMarkdownFiles(fullPath);
              } else if (file.name.endsWith('.md')) {
                processFile(fullPath);
              }
            }
          }

          function processFile(filePath) {
            let content = fs.readFileSync(filePath, 'utf8');
            
            // Check if file has frontmatter
            if (!content.startsWith('---')) {
              return;
            }

            const frontmatterEnd = content.indexOf('---', 3);
            if (frontmatterEnd === -1) {
              return;
            }

            const frontmatter = content.substring(3, frontmatterEnd);
            const body = content.substring(frontmatterEnd + 3);

            // Get Git creation date (first commit) in ISO 8601 format
            let creationDate;
            try {
              const gitDate = execSync(
                `git log --follow --format=%aI --reverse "${filePath}" | head -1`,
                { encoding: 'utf8' }
              ).trim();
              creationDate = gitDate || new Date().toISOString();
            } catch (e) {
              creationDate = new Date().toISOString();
            }

            // Parse frontmatter into lines and build a clean version
            const lines = frontmatter.split('\n');
            const cleanedLines = [];
            let hasPublished = false;
            let needsFix = false;

            for (const line of lines) {
              const trimmedLine = line.trim();
              
              // Skip empty lines at the start
              if (!trimmedLine && cleanedLines.length === 0) {
                continue;
              }

              // Check if this is a 'published' field
              const pubMatch = trimmedLine.match(/^published:\s*['"]?([^'"\n]+)['"]?$/);
              
              if (pubMatch) {
                if (hasPublished) {
                  // Skip duplicate published field
                  console.log(`Removing duplicate 'published' field in ${filePath}`);
                  needsFix = true;
                  continue;
                }
                
                const existingDate = pubMatch[1].trim().replace(/['"]/g, '');
                
                // Check if date format is correct
                if (!existingDate.includes('T') || pubMatch[1].includes("'") || pubMatch[1].includes('"')) {
                  console.log(`Fixing published date format in ${filePath}`);
                  cleanedLines.push(`published: ${creationDate}`);
                  needsFix = true;
                } else {
                  cleanedLines.push(trimmedLine);
                }
                
                hasPublished = true;
              } else {
                // Keep other fields as-is
                cleanedLines.push(line);
              }
            }

            // Add 'published' if it doesn't exist
            if (!hasPublished) {
              console.log(`Adding missing 'published' field in ${filePath}`);
              cleanedLines.push(`published: ${creationDate}`);
              needsFix = true;
            }

            if (needsFix) {
              // Rebuild frontmatter ensuring no extra blank lines at start
              let newFrontmatter = cleanedLines.join('\n').trim();
              const newContent = `---\n${newFrontmatter}\n---${body}`;
              fs.writeFileSync(filePath, newContent, 'utf8');
            }
          }

          // Process content directory (adjust path to match your structure)
          const contentDirs = ['src/content/posts', 'src/content/blog'];
          for (const dir of contentDirs) {
            if (fs.existsSync(dir)) {
              console.log(`Processing ${dir}...`);
              processMarkdownFiles(dir);
            }
          }

          console.log('Date fixing complete!');
          EOF
      
      # Commit and push fixes if any were made
      - name: Commit date fixes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ¤– Auto-fix: Update publish dates in blog posts"
          git push || true
        continue-on-error: true
      
      # Build the Astro site
      - name: Build Astro site
        run: npm run build
      
      # Deploy to Cloudflare Pages using Wrangler
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=ultimatetech --commit-dirty
